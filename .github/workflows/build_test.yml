name: Yggdrasil Decision Forests Build and Test
on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    - cron: '0 3 * * *'

jobs:
  CC-Build-And-Test:
    runs-on: linux-x86-n2-32
    container:
      image: us-docker.pkg.dev/ml-oss-artifacts-published/ml-public-container/ml-build:latest
    env:
      BAZEL_COMMON_FLAGS: >-
        --repository_cache=.bazel-cache/repository
        --disk_cache=.bazel-cache/disk
        --config=linux_cpp17
        --config=linux_avx2
        --features=-fully_static_link
        --build_tag_filters=-tf_dep,-cuda_dep
        --test_tag_filters=-tf_dep,-cuda_dep
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Cache Bazel Dependencies
        uses: actions/cache@v4
        with:
          path: .bazel-cache
          key: ${{ runner.os }}-bazel-${{ hashFiles('**/WORKSPACE', '.bazelrc') }}
          restore-keys: |
            ${{ runner.os }}-bazel-
      - name: Create Bazel Cache Directories
        run: mkdir -p .bazel-cache/repository .bazel-cache/disk
      - name: Build C++
        run: |
          bazel build //yggdrasil_decision_forests/...:all //examples:beginner_cc \
            ${{ env.BAZEL_COMMON_FLAGS }}
      - name: Test C++
        id: cc_test
        continue-on-error: true
        run: |
          bazel test //yggdrasil_decision_forests/...:all \
            ${{ env.BAZEL_COMMON_FLAGS }}
      - name: Upload Test Logs on Failure
        if: steps.cc_test.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: cc-test-logs
          path: bazel-testlogs/**/*.log
          retention-days: 30
      - name: Fail Job if Tests Failed
        if: steps.cc_test.outcome == 'failure'
        run: |
          echo "CC tests failed. See 'cc-test-logs' artifact for details."
          exit 1